generator client {
  provider = "prisma-client-js"
  output   = "./client" // set the output directory for the generated Prisma Client, to support v7
}

datasource db {
  provider = "sqlserver"
  url      = env("SQL_CONNECTION_STRING_ADMIN")
}

// NOTES
//
// use '//' comments for notes relevant to the schema
// use '///' comments for notes that should be included in the types definition
// see https://www.prisma.io/docs/concepts/components/prisma-schema#comments
//
// we use GUIDs for IDs (see https://learn.microsoft.com/en-us/sql/t-sql/data-types/uniqueidentifier-transact-sql?view=sql-server-ver16)
// this is because these IDs may be used in URLs and it makes them harder to guess
// while we don't rely on that for security, it adds an extra layer
// not everything needs this, but easier to make them all consistent and the increase in size (vs int) is negligible

model Case {
  id         String     @id @default(dbgenerated("newid()")) @db.UniqueIdentifier
  reference  String     @unique
  email      String
  createdAt  DateTime   @default(now())
  modifiedAt DateTime   @updatedAt
  Documents  Document[]

  applicationFormRelatedInformationStatusId String                 @default("not-started")
  applicationFormRelatedInformationStatus   DocumentCategoryStatus @relation(name: "ApplicationFormStatus", fields: [applicationFormRelatedInformationStatusId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  plansAndDrawingsStatusId                  String                 @default("not-started")
  plansAndDrawingsStatus                    DocumentCategoryStatus @relation(name: "PlanningAndDrawingsStatus", fields: [plansAndDrawingsStatusId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  draftDcoStatusId                          String                 @default("not-started")
  draftDcoStatus                            DocumentCategoryStatus @relation(name: "DraftDcoStatus", fields: [draftDcoStatusId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  compulsoryAcquisitionInformationStatusId  String                 @default("not-started")
  compulsoryAcquisitionInformationStatus    DocumentCategoryStatus @relation(name: "CompulsoryAcquisitionStatus", fields: [compulsoryAcquisitionInformationStatusId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  consultationReportStatusId                String                 @default("not-started")
  consultationReportStatus                  DocumentCategoryStatus @relation(name: "ConsultationReportStatus", fields: [consultationReportStatusId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  reportsAndStatementsStatusId              String                 @default("not-started")
  reportsAndStatementsStatus                DocumentCategoryStatus @relation(name: "ReportsAndStatementsStatus", fields: [reportsAndStatementsStatusId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  environmentalStatementStatusId            String                 @default("not-started")
  environmentalStatementStatus              DocumentCategoryStatus @relation(name: "EnvironmentalStatementStatus", fields: [environmentalStatementStatusId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  additionalPrescribedInformationStatusId   String                 @default("not-started")
  additionalPrescribedInformationStatus     DocumentCategoryStatus @relation(name: "AdditionalPrescribedInformationStatus", fields: [additionalPrescribedInformationStatusId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  otherDocumentsStatusId                    String                 @default("not-started")
  otherDocumentsStatus                      DocumentCategoryStatus @relation(name: "OtherDocumentsStatus", fields: [otherDocumentsStatusId], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model OneTimePassword {
  id            String   @id @default(dbgenerated("newid()")) @db.UniqueIdentifier
  email         String
  caseReference String
  hashedOtpCode String
  createdAt     DateTime @default(now())
  expiresAt     DateTime
  attempts      Int      @default(0)

  @@unique([email, caseReference])
  @@index([email])
}

model Document {
  // internal identifier
  id               String              @id @default(dbgenerated("newid()")) @db.UniqueIdentifier
  fileName         String
  uploadedDate     DateTime            @default(now())
  size             BigInt              @default(0)
  blobName         String
  isCertified      Boolean
  subCategoryId    String
  SubCategory      DocumentSubCategory @relation(fields: [subCategoryId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  apfpRegulationId String
  ApfpRegulation   ApfpRegulation      @relation(fields: [apfpRegulationId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  caseId           String              @db.UniqueIdentifier
  Case             Case                @relation(fields: [caseId], references: [id])
}

model DocumentCategory {
  /// unique machine-readable name, not generated, e.g. "application-form-related-information"
  id            String                @id
  displayName   String?
  SubCategories DocumentSubCategory[]
}

model DocumentSubCategory {
  /// unique machine-readable name, not generated, e.g. "application-cover-letter"
  id          String           @id
  displayName String?
  Document    Document[]
  categoryId  String
  Category    DocumentCategory @relation(fields: [categoryId], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model ApfpRegulation {
  /// unique machine-readable name, not generated, e.g. "5-1"
  id          String     @id
  displayName String
  Document    Document[]
}

model DocumentCategoryStatus {
  /// unique machine-readable name, not generated, e.g. "not-started"
  id          String @id
  displayName String

  ApplicationFormCases                 Case[] @relation("ApplicationFormStatus")
  PlanningAndDrawingCases              Case[] @relation("PlanningAndDrawingsStatus")
  DraftDcoCases                        Case[] @relation("DraftDcoStatus")
  CompulsoryAquisitionCases            Case[] @relation("CompulsoryAcquisitionStatus")
  ConsultationReportCases              Case[] @relation("ConsultationReportStatus")
  ReportsAndStatementsCases            Case[] @relation("ReportsAndStatementsStatus")
  EnvironmentalStatementCases          Case[] @relation("EnvironmentalStatementStatus")
  AdditionalPrescribedInformationCases Case[] @relation("AdditionalPrescribedInformationStatus")
  OtherDocumentsCases                  Case[] @relation("OtherDocumentsStatus")
}
