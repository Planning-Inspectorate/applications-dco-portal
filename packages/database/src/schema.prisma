generator client {
  provider = "prisma-client"
  output   = "./client" // set the output directory for the generated Prisma Client, to support v7
}

datasource db {
  provider = "sqlserver"
}

// NOTES
//
// use '//' comments for notes relevant to the schema
// use '///' comments for notes that should be included in the types definition
// see https://www.prisma.io/docs/concepts/components/prisma-schema#comments
//
// we use GUIDs for IDs (see https://learn.microsoft.com/en-us/sql/t-sql/data-types/uniqueidentifier-transact-sql?view=sql-server-ver16)
// this is because these IDs may be used in URLs and it makes them harder to guess
// while we don't rely on that for security, it adds an extra layer
// not everything needs this, but easier to make them all consistent and the increase in size (vs int) is negligible

model Case {
  id                   String               @id @default(dbgenerated("newid()")) @db.UniqueIdentifier
  reference            String               @unique
  email                String
  createdAt            DateTime             @default(now())
  modifiedAt           DateTime             @updatedAt
  Documents            Document[]
  SupportingEvidence   SupportingEvidence[]
  applicantDetailsId   String?              @db.UniqueIdentifier
  ApplicantDetails     ContactDetails?      @relation("ApplicantDetails", fields: [applicantDetailsId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  agentDetailsId       String?              @db.UniqueIdentifier
  AgentDetails         ContactDetails?      @relation("AgentDetails", fields: [agentDetailsId], references: [id], onDelete: SetNull, onUpdate: NoAction)
  paymentMethodId      String?
  CasePaymentMethod    PaymentMethod?       @relation(fields: [paymentMethodId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  paymentReference     String?
  Whitelist            WhitelistUser[]
  projectDescription   String?              @db.NVarChar(2000)
  projectConsentReason String?              @db.NVarChar(2000)
  locationDescription  String?              @db.NVarChar(2000)
  singleSiteId         String?              @db.UniqueIdentifier
  ProjectSingleSite    SingleSite?          @relation("ProjectSingleSite", fields: [singleSiteId], references: [id], onDelete: SetNull, onUpdate: NoAction)
  linearSiteId         String?              @db.UniqueIdentifier
  ProjectLinearSite    LinearSite?          @relation("ProjectLinearSite", fields: [linearSiteId], references: [id], onDelete: SetNull, onUpdate: NoAction)

  applicationFormRelatedInformationStatusId String                 @default("not-started")
  applicationFormRelatedInformationStatus   DocumentCategoryStatus @relation(name: "ApplicationFormStatus", fields: [applicationFormRelatedInformationStatusId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  plansAndDrawingsStatusId                  String                 @default("not-started")
  plansAndDrawingsStatus                    DocumentCategoryStatus @relation(name: "PlanningAndDrawingsStatus", fields: [plansAndDrawingsStatusId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  draftDcoStatusId                          String                 @default("not-started")
  draftDcoStatus                            DocumentCategoryStatus @relation(name: "DraftDcoStatus", fields: [draftDcoStatusId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  compulsoryAcquisitionInformationStatusId  String                 @default("not-started")
  compulsoryAcquisitionInformationStatus    DocumentCategoryStatus @relation(name: "CompulsoryAcquisitionStatus", fields: [compulsoryAcquisitionInformationStatusId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  consultationReportStatusId                String                 @default("not-started")
  consultationReportStatus                  DocumentCategoryStatus @relation(name: "ConsultationReportStatus", fields: [consultationReportStatusId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  reportsAndStatementsStatusId              String                 @default("not-started")
  reportsAndStatementsStatus                DocumentCategoryStatus @relation(name: "ReportsAndStatementsStatus", fields: [reportsAndStatementsStatusId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  environmentalStatementStatusId            String                 @default("not-started")
  environmentalStatementStatus              DocumentCategoryStatus @relation(name: "EnvironmentalStatementStatus", fields: [environmentalStatementStatusId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  additionalPrescribedInformationStatusId   String                 @default("not-started")
  additionalPrescribedInformationStatus     DocumentCategoryStatus @relation(name: "AdditionalPrescribedInformationStatus", fields: [additionalPrescribedInformationStatusId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  otherDocumentsStatusId                    String                 @default("not-started")
  otherDocumentsStatus                      DocumentCategoryStatus @relation(name: "OtherDocumentsStatus", fields: [otherDocumentsStatusId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  applicantAndAgentDetailsStatusId                String                 @default("not-started")
  applicantAndAgentDetailsStatus                  DocumentCategoryStatus @relation(name: "applicantAndAgentDetailsStatus", fields: [applicantAndAgentDetailsStatusId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  aboutTheProjectStatusId                         String                 @default("not-started")
  aboutTheProjectStatus                           DocumentCategoryStatus @relation(name: "aboutTheProjectStatus", fields: [aboutTheProjectStatusId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  consultationAndPublicityDetailsStatusId         String                 @default("not-started")
  consultationAndPublicityDetailsStatus           DocumentCategoryStatus @relation(name: "consultationAndPublicityDetailsStatus", fields: [consultationAndPublicityDetailsStatusId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  landRightsInformationStatusId                   String                 @default("not-started")
  landRightsInformationStatus                     DocumentCategoryStatus @relation(name: "landRightsInformationStatus", fields: [landRightsInformationStatusId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  habitatRegulationsAssessmentInformationStatusId String                 @default("not-started")
  habitatRegulationsAssessmentInformationStatus   DocumentCategoryStatus @relation(name: "habitatRegulationsAssessmentInformationStatus", fields: [habitatRegulationsAssessmentInformationStatusId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  floodRiskInformationStatusId                    String                 @default("not-started")
  floodRiskInformationStatus                      DocumentCategoryStatus @relation(name: "floodRiskInformationStatus", fields: [floodRiskInformationStatusId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  statutoryNuisanceInformationStatusId            String                 @default("not-started")
  statutoryNuisanceInformationStatus              DocumentCategoryStatus @relation(name: "statutoryNuisanceInformationStatus", fields: [statutoryNuisanceInformationStatusId], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model OneTimePassword {
  id            String   @id @default(dbgenerated("newid()")) @db.UniqueIdentifier
  email         String
  caseReference String
  hashedOtpCode String
  createdAt     DateTime @default(now())
  expiresAt     DateTime
  attempts      Int      @default(0)

  @@unique([email, caseReference])
  @@index([email])
}

model WhitelistUser {
  id               String            @id @default(dbgenerated("newid()")) @db.UniqueIdentifier
  caseReference    String
  email            String
  isInitialInvitee Boolean           @default(false)
  userRoleId       String
  UserRole         WhitelistUserRole @relation(fields: [userRoleId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  caseId           String            @db.UniqueIdentifier
  Case             Case              @relation(fields: [caseId], references: [id])

  @@unique([caseReference, email])
}

model WhitelistUserRole {
  /// unique machine-readable name, not generated, e.g. "super-user"
  id            String          @id
  displayName   String?
  WhitelistUser WhitelistUser[]
}

model Document {
  /// internal identifier
  id                 String               @id @default(dbgenerated("newid()")) @db.UniqueIdentifier
  fileName           String
  uploadedDate       DateTime             @default(now())
  size               BigInt               @default(0)
  blobName           String
  isCertified        Boolean
  subCategoryId      String
  SubCategory        DocumentSubCategory  @relation(fields: [subCategoryId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  apfpRegulationId   String
  ApfpRegulation     ApfpRegulation       @relation(fields: [apfpRegulationId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  caseId             String               @db.UniqueIdentifier
  Case               Case                 @relation(fields: [caseId], references: [id], onDelete: Cascade)
  supportingEvidence SupportingEvidence[]
}

model SupportingEvidence {
  /// internal identifier
  id            String              @id @default(dbgenerated("newid()")) @db.UniqueIdentifier
  caseId        String              @db.UniqueIdentifier
  Case          Case                @relation(fields: [caseId], references: [id], onDelete: Cascade)
  documentId    String              @db.UniqueIdentifier
  Document      Document            @relation(fields: [documentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  subCategoryId String
  SubCategory   DocumentSubCategory @relation(fields: [subCategoryId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@unique([caseId, documentId, subCategoryId])
}

model DocumentCategory {
  /// unique machine-readable name, not generated, e.g. "application-form-related-information"
  id            String                @id
  displayName   String?
  SubCategories DocumentSubCategory[]
}

model DocumentSubCategory {
  /// unique machine-readable name, not generated, e.g. "application-cover-letter"
  id                 String               @id
  displayName        String?
  Document           Document[]
  SupportingEvidence SupportingEvidence[]
  categoryId         String
  Category           DocumentCategory     @relation(fields: [categoryId], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model ApfpRegulation {
  /// unique machine-readable name, not generated, e.g. "5-1"
  id          String     @id
  displayName String
  Document    Document[]
}

model DocumentCategoryStatus {
  /// unique machine-readable name, not generated, e.g. "not-started"
  id          String @id
  displayName String

  ApplicationFormCases                 Case[] @relation("ApplicationFormStatus")
  PlanningAndDrawingCases              Case[] @relation("PlanningAndDrawingsStatus")
  DraftDcoCases                        Case[] @relation("DraftDcoStatus")
  CompulsoryAquisitionCases            Case[] @relation("CompulsoryAcquisitionStatus")
  ConsultationReportCases              Case[] @relation("ConsultationReportStatus")
  ReportsAndStatementsCases            Case[] @relation("ReportsAndStatementsStatus")
  EnvironmentalStatementCases          Case[] @relation("EnvironmentalStatementStatus")
  AdditionalPrescribedInformationCases Case[] @relation("AdditionalPrescribedInformationStatus")
  OtherDocumentsCases                  Case[] @relation("OtherDocumentsStatus")

  ApplicantAndAgentDetailsCases                Case[] @relation("applicantAndAgentDetailsStatus")
  AboutTheProjectCases                         Case[] @relation("aboutTheProjectStatus")
  ConsultationAndPublicityDetailsCases         Case[] @relation("consultationAndPublicityDetailsStatus")
  LandRightsInformationCases                   Case[] @relation("landRightsInformationStatus")
  habitatRegulationsAssessmentInformationCases Case[] @relation("habitatRegulationsAssessmentInformationStatus")
  FloodRiskInformationCases                    Case[] @relation("floodRiskInformationStatus")
  StatutoryNuisanceInformationCases            Case[] @relation("statutoryNuisanceInformationStatus")
}

model ContactDetails {
  id           String      @id @default(dbgenerated("newid()")) @db.UniqueIdentifier
  firstName    String
  lastName     String
  emailAddress String
  phone        String
  organisation String
  addressId    String      @db.UniqueIdentifier
  Address      FullAddress @relation(fields: [addressId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  CaseApplicant Case[] @relation("ApplicantDetails")
  CaseAgent     Case[] @relation("AgentDetails")
}

model PaymentMethod {
  /// unique machine-readable name, not generated, e.g. "bacs"
  id                String @id
  displayName       String
  CasePaymentMethod Case[]
}

model NsipProject {
  /// relation used for integration with CBOS NSIP Project topic
  caseId        String @id
  caseReference String @unique

  projectName        String?
  projectDescription String?
  projectLocation    String?

  easting  Int?
  northing Int?
}

model NsipServiceUser {
  /// relation used for integration with CBOS Service User topic
  id              String   @id
  caseReference   String
  email           String
  modifiedAt      DateTime @updatedAt
  serviceUserType String?

  firstName       String?
  lastName        String?
  organisation    String?
  telephoneNumber String?

  addressLine1   String?
  addressLine2   String?
  addressTown    String?
  addressCounty  String?
  postcode       String?
  addressCountry String?

  @@unique([caseReference, email])
}

model FullAddress {
  id             String           @id @default(dbgenerated("newid()")) @db.UniqueIdentifier
  addressLine1   String
  addressLine2   String
  townCity       String
  county         String?
  country        String
  postcode       String
  ContactDetails ContactDetails[]
}

model SingleSite {
  id       String @id @default(dbgenerated("newid()")) @db.UniqueIdentifier
  easting  Int
  northing Int

  SingleSiteCase Case[] @relation("ProjectSingleSite")
}

model LinearSite {
  id             String @id @default(dbgenerated("newid()")) @db.UniqueIdentifier
  startEasting   Int
  startNorthing  Int
  middleEasting  Int
  middleNorthing Int
  endEasting     Int
  endNorthing    Int

  LinearSiteCase Case[] @relation("ProjectLinearSite")
}
