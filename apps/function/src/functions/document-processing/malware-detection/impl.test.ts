// @ts-nocheck
import assert from 'node:assert';
import { describe, it, mock } from 'node:test';
import { buildMalwareDetectionHandler } from './impl.ts';

describe('malware detection function', () => {
	it('should save document scan result into db when message received', async () => {
		const mockDb = {
			$transaction: mock.fn((fn) => fn(mockDb)),
			document: {
				findFirst: mock.fn(() => ({
					id: 'document-id-1'
				})),
				update: mock.fn()
			}
		};
		const context = {
			log: mock.fn()
		};
		const eventGridEvent = {
			data: {
				blobUri: 'EN123456/draft-dco/draft-development-consent-order/test.pdf',
				scanResultType: 'Malicious'
			}
		};

		const handler = buildMalwareDetectionHandler({ db: mockDb });
		await handler(eventGridEvent, context);

		assert.strictEqual(mockDb.document.update.mock.calls.length, 1);
		assert.deepStrictEqual(mockDb.document.update.mock.calls[0].arguments[0], {
			where: {
				id: 'document-id-1'
			},
			data: {
				ScanResult: {
					connect: {
						id: 'affected'
					}
				}
			}
		});

		assert.strictEqual(context.log.mock.callCount(), 1);
	});
	it('should throw an error if event grid event data is not present', async () => {
		const handler = buildMalwareDetectionHandler({});
		await assert.rejects(() => handler({}, {}), {
			message: 'Received no input'
		});
	});
	it('should throw an error if info can not be obtained from blob uri', async () => {
		const eventGridEvent = {
			data: {
				blobUri: 'invalid-blob',
				scanResultType: 'Malicious'
			}
		};

		const handler = buildMalwareDetectionHandler({});
		await assert.rejects(() => handler(eventGridEvent, {}), {
			message: 'Not possible to extract info from blob with URI invalid-blob'
		});
	});
	it('should throw an error if scan result is not valid', async () => {
		const eventGridEvent = {
			data: {
				blobUri: 'EN123456/draft-dco/draft-development-consent-order/test.pdf',
				scanResultType: 'Invalid'
			}
		};
		const context = {
			error: mock.fn()
		};

		const handler = buildMalwareDetectionHandler({});
		await assert.rejects(() => handler(eventGridEvent, context), {
			message: "Error during malware detection function run: Could not map scan result 'Invalid' to a document status"
		});

		assert.strictEqual(context.error.mock.callCount(), 1);
	});
	it('should throw an error if issue encountered saving scan result to the database', async () => {
		const mockDb = {
			$transaction: mock.fn((fn) => fn(mockDb)),
			document: {
				findFirst: mock.fn(() => ({
					id: 'document-id-1'
				})),
				update: mock.fn(() => {
					throw new Error('Error', { code: 'E1' });
				})
			}
		};
		const eventGridEvent = {
			data: {
				blobUri: 'EN123456/draft-dco/draft-development-consent-order/test.pdf',
				scanResultType: 'Malicious'
			}
		};
		const context = {
			error: mock.fn()
		};

		const handler = buildMalwareDetectionHandler({ db: mockDb });
		await assert.rejects(() => handler(eventGridEvent, context), {
			message: 'Error during malware detection function run: Error'
		});
	});
});
