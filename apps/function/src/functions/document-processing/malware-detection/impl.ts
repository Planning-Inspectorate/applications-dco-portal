import type { FunctionService } from '../../../service.ts';
import type { EventGridEvent, InvocationContext, ServiceBusTopicHandler } from '@azure/functions';

export function buildNsipProjectFunction(service: FunctionService) {
	return async (eventGridEvent: EventGridEvent, context: InvocationContext) => {
		const { db } = service;

		if (!eventGridEvent?.data) {
			throw new Error('Received no input');
		}

		const { blobUri, scanResultType } = eventGridEvent.data;

		try {
			const x = statusFromScanResult(scanResultType as string);
			db.document.update({
				where: {
					blobName: blobUri as string
				}
			});

			context.info(`Document scan report for document: ${id}`);
		} catch (error) {
			let errorMessage;
			if (error instanceof Error) {
				context.error('Error during malware detection function run: ', error);
				errorMessage = error.message;
			}
			throw new Error('Error during malware detection function run: ' + errorMessage);
		}
	};
}

const statusFromScanResult = (scanResult: string): string => {
	switch (scanResult) {
		case 'Malicious':
			return 'affected';
		case 'No threats found':
			return 'scanned';
		default:
			throw new Error(`Could not map scan result '${scanResult}' to a document status`);
	}
};
