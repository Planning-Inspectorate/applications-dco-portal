import type { FunctionService } from '../../../service.ts';
import type { EventGridEvent, InvocationContext } from '@azure/functions';

export function buildMalwareDetectionHandler(service: FunctionService) {
	return async (eventGridEvent: EventGridEvent, context: InvocationContext) => {
		const { db } = service;

		if (!eventGridEvent?.data) {
			throw new Error('Received no input');
		}

		const { blobUri, scanResultType } = eventGridEvent.data;
		const info = getInfoFromBlobURI(blobUri as string);

		if (!info) {
			throw new Error(`Not possible to extract info from blob with URI ${blobUri}`);
		}

		const { caseReference, documentSubCategoryId, fileName } = info;

		try {
			const scanResult = statusFromScanResult(scanResultType as string);
			await db.$transaction(async ($tx) => {
				const documentToUpdate = await $tx.document.findFirst({
					where: {
						fileName,
						subCategoryId: documentSubCategoryId,
						blobName: blobUri as string,
						Case: {
							reference: caseReference
						}
					}
				});

				if (!documentToUpdate) {
					throw new Error(`Document not found in database with URI ${blobUri}`);
				}

				$tx.document.update({
					where: {
						id: documentToUpdate.id
					},
					data: {
						ScanResult: {
							connect: {
								id: scanResult
							}
						}
					}
				});
			});

			context.log(`Document scan complete for document: ${blobUri}`);
		} catch (error) {
			let errorMessage;
			if (error instanceof Error) {
				context.error('Error during malware detection function run: ', error);
				errorMessage = error.message;
			}
			throw new Error('Error during malware detection function run: ' + errorMessage);
		}
	};
}

function statusFromScanResult(scanResult: string): string {
	switch (scanResult) {
		case 'Malicious':
			return 'affected';
		case 'No threats found':
			return 'scanned';
		default:
			throw new Error(`Could not map scan result '${scanResult}' to a document status`);
	}
}

function getInfoFromBlobURI(uri: string) {
	const match = uri.match(/^([^/]+)\/([^/]+)\/([^/]+)\/(.+)$/);

	if (!match) {
		return null;
	}

	const caseReference = match?.[1] ?? null;
	const documentCategoryId = match?.[2] ?? null;
	const documentSubCategoryId = match?.[3] ?? null;
	const fileName = decodeURIComponent(match?.[4]) ?? null;

	if (caseReference && documentCategoryId && documentSubCategoryId && fileName) {
		return {
			caseReference,
			documentCategoryId,
			documentSubCategoryId,
			fileName
		};
	}
}
